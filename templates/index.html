<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <title>High Five | Pro Max</title>
    <style>
        body { overflow: hidden; height: 100vh; touch-action: none; transition: background 0.8s ease; }
        .bg-chill { background: radial-gradient(circle at center, #1e1b4b, #020617); }
        .bg-active { background: radial-gradient(circle at center, #4338ca, #020617); }
        .bg-hot { background: radial-gradient(circle at center, #7c3aed, #020617); }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .squish:active { transform: scale(0.94); }
        #nuke-slide { transform: translateY(-200%); transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); z-index: 100; }
        #nuke-slide.active { transform: translateY(0); }
        .float-emoji { position: absolute; bottom: 120px; animation: floatUp 2.5s ease-out forwards; font-size: 3.5rem; pointer-events: none; z-index: 50; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-500px) rotate(20deg); opacity: 0; } }
    </style>
</head>
<body class="bg-chill text-white flex flex-col items-center justify-between p-6">

    <div id="nuke-slide" class="fixed top-6 left-6 right-6 glass bg-indigo-600/90 p-6 rounded-[2.5rem] shadow-2xl border-2 border-white/20">
        <p class="text-[10px] font-black uppercase tracking-widest mb-1 opacity-70">üö® Icebreaker Triggered</p>
        <p id="nuke-text" class="text-lg font-bold italic leading-tight"></p>
    </div>

    <div class="w-full flex justify-between items-center glass p-5 rounded-[2.5rem]">
        <button onclick="reportUser()" class="text-xs font-black text-red-400 uppercase tracking-widest squish bg-red-500/10 px-4 py-2 rounded-full">Report</button>
        <div id="partner-vibe" class="hidden text-[10px] font-black bg-indigo-500 px-4 py-2 rounded-full uppercase tracking-widest shadow-lg shadow-indigo-500/20 animate-pulse">Ready</div>
    </div>

    <div id="main-stage" class="relative w-full flex-1 flex flex-col items-center justify-center">
        <div class="relative w-72 h-72 flex items-center justify-center">
            <div id="visualizer-ring" class="absolute inset-0 rounded-full border-[16px] border-indigo-500/10 shadow-[0_0_60px_rgba(99,102,241,0.1)] transition-transform duration-75"></div>
            <div class="text-center z-10">
                <p id="partner-status" class="text-xs font-bold opacity-30 uppercase tracking-widest mb-2">Searching...</p>
                <div id="timer" class="text-7xl font-black tracking-tighter tabular-nums text-indigo-100">05:00</div>
            </div>
        </div>
    </div>

    <div class="w-full space-y-4 pb-4">
        <div id="reveal-card" class="hidden p-6 bg-gradient-to-br from-emerald-400 to-teal-600 rounded-[2.5rem] text-center shadow-2xl animate-bounce">
            <p class="text-[10px] uppercase font-black mb-1 opacity-80">üî• Mutual High Five!</p>
            <div id="reveal-text" class="text-xl font-black"></div>
        </div>

        <div id="emoji-dock" class="hidden flex justify-center gap-6 mb-4">
            <button onclick="sendEmoji('üî•')" class="text-3xl squish">üî•</button>
            <button onclick="sendEmoji('üñêÔ∏è')" class="text-3xl squish">üñêÔ∏è</button>
            <button onclick="sendEmoji('üåå')" class="text-3xl squish">üåå</button>
            <button onclick="sendEmoji('üòÇ')" class="text-3xl squish">üòÇ</button>
        </div>

        <button id="main-action" onclick="findMatch()" class="squish w-full py-6 rounded-[2.5rem] bg-white text-indigo-900 font-black text-xl shadow-2xl transition-all tracking-tight">
            SEARCHING...
        </button>
    </div>

    <script>
        const socket = io();
        let pc, localStream, currentRoom, silenceStart;
        
        // PRE-PRIME AUDIO OBJECT FOR MOBILE
        let remoteAudio = new Audio();
        remoteAudio.autoplay = true;
        remoteAudio.playsInline = true;

        window.onload = () => socket.emit('find_match');

        function findMatch() {
            socket.emit('find_match');
            document.getElementById('main-action').innerText = "SEARCHING...";
            document.getElementById('main-action').disabled = true;
        }

        socket.on('match_success', async (data) => {
            currentRoom = data.room_id;
            document.getElementById('partner-status').innerText = `Talking to ${data.partner.username}`;
            document.getElementById('partner-vibe').innerText = data.partner.vibe;
            document.getElementById('partner-vibe').classList.remove('hidden');
            document.getElementById('emoji-dock').classList.remove('hidden');
            
            const btn = document.getElementById('main-action');
            btn.disabled = false;
            btn.innerText = "GIVE HIGH FIVE üñêÔ∏è";
            btn.className = "squish w-full py-6 rounded-[2.5rem] bg-indigo-500 text-white font-black text-xl shadow-xl transition-all";
            btn.onclick = () => { 
                socket.emit('give_high_five', {room_id: currentRoom}); 
                btn.innerText = "WAITING FOR PARTNER..."; 
                btn.disabled = true; 
            };

            await startAudio();
            setupRTC(data.initiator);
            startCountdown(data.end_time);
        });

        async function startAudio() {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new AudioContext();
            const analyzer = ctx.createAnalyser();
            ctx.createMediaStreamSource(localStream).connect(analyzer);
            const d = new Uint8Array(analyzer.frequencyBinCount);
            silenceStart = Date.now();

            const frame = () => {
                analyzer.getByteFrequencyData(d);
                const vol = d.reduce((a,b)=>a+b)/d.length;
                document.getElementById('visualizer-ring').style.transform = `scale(${1 + (vol/40)})`;
                if(vol > 15) document.body.className = "bg-hot text-white";
                else if(vol > 5) document.body.className = "bg-active text-white";
                else document.body.className = "bg-chill text-white";

                if(vol < 3 && (Date.now() - silenceStart > 10000)) { 
                    socket.emit('nuke_triggered', {room_id: currentRoom});
                    silenceStart = Date.now();
                } else if(vol >= 3) silenceStart = Date.now();
                requestAnimationFrame(frame);
            };
            frame();
        }

        function setupRTC(initiator) {
            pc = new RTCPeerConnection({ iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', password: 'openrelayproject' }
            ]});

            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.ontrack = (e) => {
                console.log("Remote track received!");
                remoteAudio.srcObject = e.streams[0];
                // Force play for mobile browser compatibility
                remoteAudio.play().catch(err => {
                    console.log("Autoplay blocked, waiting for interaction");
                    document.getElementById('partner-status').innerText = "TAP TO HEAR PARTNER üîä";
                    document.getElementById('partner-status').onclick = () => remoteAudio.play();
                });
            };

            pc.onicecandidate = (e) => { 
                if(e.candidate) socket.emit('signal', {room_id: currentRoom, candidate: e.candidate}); 
            };

            if(initiator) {
                pc.onnegotiationneeded = async () => {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    socket.emit('signal', {room_id: currentRoom, sdp: pc.localDescription});
                };
            }
        }

        socket.on('signal', async (d) => {
            if(d.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(d.sdp));
                if(pc.remoteDescription.type === 'offer') {
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    socket.emit('signal', {room_id: currentRoom, sdp: pc.localDescription});
                }
            } else if(d.candidate) pc.addIceCandidate(new RTCIceCandidate(d.candidate));
        });

        function sendEmoji(emoji) {
            spawnEmoji(emoji);
            socket.emit('send_react', { room_id: currentRoom, emoji: emoji });
        }

        socket.on('incoming_react', (data) => spawnEmoji(data.emoji));

        function spawnEmoji(emoji) {
            const e = document.createElement('div');
            e.className = 'float-emoji';
            e.innerText = emoji;
            e.style.left = Math.random() * 70 + 15 + '%';
            document.getElementById('main-stage').appendChild(e);
            setTimeout(() => e.remove(), 2500);
        }

        socket.on('partner_ready_to_reveal', () => {
            document.getElementById('partner-status').innerText = "Partner is ready to swap! üñêÔ∏è";
            document.getElementById('partner-status').classList.add('text-green-400', 'animate-pulse');
        });

        socket.on('mutual_match', (data) => {
            const partner = Object.values(data.handles).find(u => u.username !== "{{ username }}");
            document.getElementById('reveal-text').innerHTML = `${partner.platform}: ${partner.social}`;
            document.getElementById('reveal-card').classList.remove('hidden');
        });

        socket.on('topic_nuke', (data) => {
            const slide = document.getElementById('nuke-slide');
            document.getElementById('nuke-text').innerText = data.topic;
            slide.classList.add('active');
            setTimeout(() => slide.classList.remove('active'), 12000);
        });

        function reportUser() {
            if(confirm("Report and block this user immediately?")) {
                socket.emit('report_user', {room_id: currentRoom});
            }
        }

        socket.on('security_terminate', (data) => {
            alert(data.msg);
            location.reload();
        });

        function startCountdown(end) {
            const iv = setInterval(() => {
                const diff = Math.max(0, Math.floor(end - Date.now()/1000));
                const m = Math.floor(diff/60), s = diff%60;
                document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                if(diff === 0) { clearInterval(iv); location.reload(); }
            }, 1000);
        }
    </script>
</body>
</html>