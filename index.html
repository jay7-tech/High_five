<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>High Five - The 5 Minute Friend</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 50px; }
        #status { font-size: 1.2em; color: #555; margin-bottom: 20px; }
        
        /* The "Nuke" Popup Card */
        #topic-card {
            display: none;
            background: #ff4757;
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(255, 71, 87, 0.4);
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px auto;
            width: 80%;
            max-width: 400px;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* Visualizer Bar */
        #volume-meter {
            width: 300px; height: 20px; background: #ddd; margin: 20px auto; border-radius: 10px; overflow: hidden;
        }
        #volume-fill {
            height: 100%; width: 0%; background: #2ed573; transition: width 0.1s;
        }

        button {
            padding: 15px 30px; font-size: 1.2em; background: #3742fa; color: white;
            border: none; border-radius: 50px; cursor: pointer; transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>

    <h1>üñêÔ∏è High Five</h1>
    <div id="status">Ready to connect...</div>
    
    <div id="volume-meter"><div id="volume-fill"></div></div>
    <p id="silence-timer" style="color: #888;">Silence: 0s</p>

    <div id="topic-card">Topic goes here...</div>

    <button onclick="startApp()">Find a Match</button>

    <script>
        const socket = io('http://localhost:5000'); // Connect to your Python server
        let currentRoom = null;
        let audioContext, analyser, microphone, silenceStart;
        const SILENCE_THRESHOLD = 0.02; // Volume level considered "silent" (0.0 to 1.0)
        const SILENCE_LIMIT = 5000; // 5 seconds (Start small for testing!)

        // 1. Socket Event Listeners
        socket.on('connect', () => {
            document.getElementById('status').innerText = "Connected to Server. Click to start.";
        });

        socket.on('waiting_for_match', (data) => {
            document.getElementById('status').innerText = "Waiting for a partner...";
        });

        socket.on('match_success', (data) => {
            currentRoom = data.room_id;
            document.getElementById('status').innerText = "Match Found! You are in room: " + data.room_id.substring(0,5) + "...";
            // Start listening to the mic when match starts
            initAudio();
        });

        socket.on('topic_nuke_display', (data) => {
            // SHOW THE NUKE!
            const card = document.getElementById('topic-card');
            card.innerText = "üö® " + data.topic;
            card.style.display = 'block';
            
            // Reset silence timer so it doesn't trigger again immediately
            silenceStart = Date.now(); 
            
            // Hide it after 10 seconds
            setTimeout(() => { card.style.display = 'none'; }, 10000);
        });

        function startApp() {
            socket.emit('find_match');
        }

        // 2. The Technical Toy Box: Audio Analysis
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                silenceStart = Date.now();
                
                checkVolume();

                function checkVolume() {
                    analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate average volume (RMS-ish)
                    let sum = 0;
                    for(let i = 0; i < bufferLength; i++) { sum += dataArray[i]; }
                    let average = sum / bufferLength;
                    
                    // Normalize to 0-1 range roughly
                    let volume = average / 128.0; 

                    // Update Visualizer
                    document.getElementById('volume-fill').style.width = (volume * 100 * 2) + '%'; // x2 for sensitivity

                    // --- THE SILENCE LOGIC ---
                    if (volume < SILENCE_THRESHOLD) {
                        let silentFor = Date.now() - silenceStart;
                        document.getElementById('silence-timer').innerText = `Silence: ${(silentFor/1000).toFixed(1)}s`;

                        if (silentFor > SILENCE_LIMIT) {
                            // Trigger the Nuke!
                            console.log("Too quiet! Triggering Nuke...");
                            socket.emit('nuke_triggered', { room_id: currentRoom });
                            silenceStart = Date.now(); // Reset timer
                        }
                    } else {
                        // Noise detected! Reset timer.
                        silenceStart = Date.now();
                        document.getElementById('silence-timer').innerText = "Silence: 0s";
                    }

                    requestAnimationFrame(checkVolume);
                }

            } catch (err) {
                console.error("Microphone access denied!", err);
                alert("You need to allow microphone access for this to work!");
            }
        }
    </script>
</body>
</html>